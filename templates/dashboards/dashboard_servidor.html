{% extends 'base.html' %}

{% block title %}Minhas Tarefas{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h1 class="page-title">Minhas Tarefas</h1>
    <p class="page-subtitle">
        <i class="bi bi-person-badge"></i> {{ user.nome_completo }} (SIAPE: {{ user.siape }})
    </p>
</div>

{% if kpis.bloqueado %}
<div class="alert alert-danger mb-4">
    <h5><i class="bi bi-exclamation-triangle-fill"></i> Voc√™ est√° bloqueado!</h5>
    <p class="mb-0">
        Seu acesso foi temporariamente bloqueado. Entre em contato com a coordena√ß√£o para mais informa√ß√µes.
        <br><strong>Motivo:</strong> {{ user.motivo_bloqueio|default:"N√£o especificado" }}
    </p>
</div>
{% endif %}

<!-- ============================================
     SE√á√ÉO 1: KPIs DE CRITICIDADE (5 N√çVEIS)
     ============================================ -->
<div class="row mb-4">
    <!-- Total de Tarefas -->
    <div class="col-md-2">
        <div class="kpi-card">
            <div class="kpi-value">{{ kpis.total }}</div>
            <div class="kpi-label">Total de Tarefas</div>
        </div>
    </div>
    
    <!-- üî¥ CR√çTICAS -->
    <div class="col-md-2">
        <div class="kpi-card" style="border-left: 4px solid #dc3545;">
            <div class="kpi-value" style="color: #dc3545;">
                üî¥ {{ kpis.criticas }}
            </div>
            <div class="kpi-label">Cr√≠ticas</div>
            <small class="text-muted">{{ kpis.percentual_criticas }}%</small>
        </div>
    </div>
    
    <!-- üü† ALTAS -->
    <div class="col-md-2">
        <div class="kpi-card" style="border-left: 4px solid #fd7e14;">
            <div class="kpi-value" style="color: #fd7e14;">
                üü† {{ kpis.altas }}
            </div>
            <div class="kpi-label">Altas</div>
            <small class="text-muted">{{ kpis.percentual_altas }}%</small>
        </div>
    </div>
    
    <!-- üü° M√âDIAS -->
    <div class="col-md-2">
        <div class="kpi-card" style="border-left: 4px solid #ffc107;">
            <div class="kpi-value" style="color: #f39c12;">
                üü° {{ kpis.medias }}
            </div>
            <div class="kpi-label">M√©dias</div>
            <small class="text-muted">{{ kpis.percentual_medias }}%</small>
        </div>
    </div>
    
    <!-- üü¢ BAIXAS -->
    <div class="col-md-2">
        <div class="kpi-card" style="border-left: 4px solid #28a745;">
            <div class="kpi-value" style="color: #28a745;">
                üü¢ {{ kpis.baixas }}
            </div>
            <div class="kpi-label">Baixas</div>
        </div>
    </div>
    
    <!-- ‚ö™ NORMAIS -->
    <div class="col-md-2">
        <div class="kpi-card" style="border-left: 4px solid #6c757d;">
            <div class="kpi-value" style="color: #6c757d;">
                ‚ö™ {{ kpis.normais }}
            </div>
            <div class="kpi-label">Normais</div>
        </div>
    </div>
</div>

<!-- Alertas de Tarefas Priorit√°rias -->
{% if kpis.criticas > 0 %}
<div class="alert alert-danger mb-4">
    <h5><i class="fas fa-exclamation-circle"></i> <strong>{{ kpis.criticas }}</strong> tarefas CR√çTICAS precisam de a√ß√£o imediata!</h5>
    <p class="mb-0">Essas tarefas ultrapassaram severamente os prazos estabelecidos. Priorize sua an√°lise.</p>
</div>
{% endif %}

{% if kpis.altas > 0 %}
<div class="alert alert-warning mb-4">
    <h5><i class="fas fa-exclamation-triangle"></i> <strong>{{ kpis.altas }}</strong> tarefas com prioridade ALTA</h5>
    <p class="mb-0">Essas tarefas excederam os prazos e requerem aten√ß√£o.</p>
</div>
{% endif %}

{% if ultima_carga %}
<div class="alert alert-info mb-4">
    <i class="bi bi-clock-history"></i>
    <strong>√öltima atualiza√ß√£o dos dados:</strong>
    {{ ultima_carga|date:"d/m/Y H:i" }}
</div>
{% endif %}

<!-- ============================================
     SE√á√ÉO 2: TAREFAS PRIORIT√ÅRIAS (TOP 10)
     ============================================ -->
{% if tarefas_prioritarias %}
<div class="card-custom mb-4">
    <div class="card-header-custom">
        <h2 class="card-title-custom">
            <i class="fas fa-exclamation-triangle"></i>
            Tarefas Priorit√°rias ({{ tarefas_prioritarias|length }})
        </h2>
    </div>
    <div class="card-body-custom">
        <div class="table-responsive">
            <table class="table table-custom table-hover">
                <thead>
                    <tr>
                        <th>Criticidade</th>
                        <th>Protocolo</th>
                        <th>Servi√ßo</th>
                        <th>Status</th>
                        <th>Regra</th>
                        <th>Alerta</th>
                        <th>Dias Pendente</th>
                        <th>Prazo Limite</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tarefa in tarefas_prioritarias %}
                    <tr style="border-left: 4px solid {{ tarefa.cor_criticidade }};">
                        <td>
                            <span class="badge" style="background-color: {{ tarefa.cor_criticidade }}; color: white;">
                                {{ tarefa.emoji_criticidade }} {{ tarefa.nivel_criticidade }}
                            </span>
                        </td>
                        <td><strong>{{ tarefa.numero_protocolo_tarefa }}</strong></td>
                        <td>{{ tarefa.nome_servico|truncatewords:3 }}</td>
                        <td>
                            {% if tarefa.status_tarefa == 'Pendente' %}
                                <span class="badge-custom badge-warning">Pendente</span>
                            {% elif tarefa.status_tarefa == 'Cumprimento de exig√™ncia' %}
                                <span class="badge-custom badge-info">Cumprimento</span>
                            {% else %}
                                <span class="badge-custom badge-secondary">{{ tarefa.status_tarefa }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ tarefa.regra_aplicada }}</small>
                        </td>
                        <td>
                            <small>{{ tarefa.alerta_criticidade|truncatewords:8 }}</small>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-danger">{{ tarefa.dias_pendente_criticidade }}</span>
                        </td>
                        <td class="text-center">
                            <small class="text-muted">{{ tarefa.prazo_limite_criticidade }} dias</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- ============================================
     SE√á√ÉO 3: RESUMO POR SERVI√áO
     ============================================ -->
{% if servicos_resumo %}
<div class="card-custom mb-4">
    <div class="card-header-custom">
        <h2 class="card-title-custom">
            <i class="fas fa-chart-bar"></i>
            Resumo por Tipo de Servi√ßo
        </h2>
    </div>
    <div class="card-body-custom">
        <div class="table-responsive">
            <table class="table table-custom table-sm">
                <thead>
                    <tr>
                        <th>Servi√ßo</th>
                        <th class="text-center">Total</th>
                        <th class="text-center">üî¥ Cr√≠ticas</th>
                        <th class="text-center">üü† Altas</th>
                        <th class="text-center">üü° M√©dias</th>
                    </tr>
                </thead>
                <tbody>
                    {% for servico in servicos_resumo %}
                    <tr>
                        <td><strong>{{ servico.nome|truncatewords:6 }}</strong></td>
                        <td class="text-center">
                            <span class="badge bg-primary">{{ servico.total }}</span>
                        </td>
                        <td class="text-center">
                            {% if servico.criticas > 0 %}
                                <span class="badge bg-danger">{{ servico.criticas }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if servico.altas > 0 %}
                                <span class="badge bg-warning text-dark">{{ servico.altas }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if servico.medias > 0 %}
                                <span class="badge bg-info text-dark">{{ servico.medias }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- ============================================
     SE√á√ÉO 4: TODAS AS TAREFAS
     ============================================ -->
<div class="card-custom">
    <div class="card-header-custom">
        <h2 class="card-title-custom">
            Lista Completa de Tarefas ({{ tarefas.count }})
        </h2>
    </div>
    <div class="card-body-custom">
        <div class="table-responsive">
            <table class="table table-custom" id="tabela-tarefas">
                <thead>
                    <tr>
                        <th>Criticidade</th>
                        <th>Protocolo</th>
                        <th>Servi√ßo</th>
                        <th>Status</th>
                        <th>Alerta</th>
                        <th>Distribui√ß√£o</th>
                        <th class="text-center">Dias Pend√™ncia</th>
                        <th>Descri√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tarefa in tarefas %}
                    <tr style="border-left: 4px solid {{ tarefa.cor_criticidade }};">
                        <!-- Criticidade -->
                        <td>
                            {{ tarefa.badge_html_criticidade|safe }}
                        </td>
                        
                        <!-- Protocolo -->
                        <td><strong>{{ tarefa.numero_protocolo_tarefa }}</strong></td>
                        
                        <!-- Servi√ßo -->
                        <td>{{ tarefa.nome_servico|truncatewords:3 }}</td>
                        
                        <!-- Status -->
                        <td>
                            {% if tarefa.status_tarefa == 'Pendente' %}
                                <span class="badge-custom badge-warning">{{ tarefa.status_tarefa }}</span>
                            {% elif tarefa.status_tarefa == 'Cumprimento de exig√™ncia' %}
                                <span class="badge-custom badge-info">Cumprimento</span>
                            {% else %}
                                <span class="badge-custom badge-success">{{ tarefa.status_tarefa }}</span>
                            {% endif %}
                        </td>
                        
                        <!-- Alerta -->
                        <td>
                            {% if tarefa.tem_criticidade %}
                                <small class="text-muted">{{ tarefa.alerta_criticidade|truncatewords:6 }}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        
                        <!-- Distribui√ß√£o -->
                        <td>{{ tarefa.data_distribuicao_tarefa|date:"d/m/Y"|default:"-" }}</td>
                        
                        <!-- Dias Pend√™ncia -->
                        <td class="text-center">
                            {% if tarefa.tempo_em_pendencia_em_dias > 60 %}
                                <span class="badge-custom badge-danger">{{ tarefa.tempo_em_pendencia_em_dias }}</span>
                            {% elif tarefa.tempo_em_pendencia_em_dias > 30 %}
                                <span class="badge-custom badge-warning">{{ tarefa.tempo_em_pendencia_em_dias }}</span>
                            {% else %}
                                <strong>{{ tarefa.tempo_em_pendencia_em_dias }}</strong>
                            {% endif %}
                        </td>
                        
                        <!-- Descri√ß√£o -->
                        <td>
                            <small class="text-muted">{{ tarefa.descricao_cumprimento_exigencia_tarefa|truncatewords:6 }}</small>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inbox" style="font-size: 48px;"></i>
                            <p class="mt-2">Nenhuma tarefa atribu√≠da no momento</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Legenda -->
<div class="mt-3">
    <small class="text-muted">
        <strong>Legenda de Criticidade:</strong>
        <span class="badge bg-danger ms-2">üî¥ CR√çTICA - A√ß√£o imediata necess√°ria</span>
        <span class="badge bg-warning text-dark ms-2">üü† ALTA - Prazo excedido</span>
        <span class="badge" style="background-color: #ffc107; color: black;" class="ms-2">üü° M√âDIA - Pr√≥ximo do vencimento</span>
        <span class="badge bg-success ms-2">üü¢ BAIXA - Em observa√ß√£o</span>
        <span class="badge bg-secondary ms-2">‚ö™ NORMAL - Dentro do prazo</span>
    </small>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Inicializar DataTable
    $('#tabela-tarefas').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json"
        },
        "order": [[0, "asc"]], // Ordenar por criticidade
        "pageLength": 50,
        "responsive": true
    });
});
</script>
{% endblock %}